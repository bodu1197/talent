# 🔔 알림 시스템 점검 보고서

**프로젝트**: AI Talent Hub (달리고)  
**검사일**: 2026-01-17  
**점검 범위**: 판매자, 구매자, 라이더(헬퍼), 요청자, 관리자 간 상호 알림

---

## 📊 알림 시스템 종합 현황

| 영역            | 트리거 방식     | 적용 상태 |
| --------------- | --------------- | --------- |
| **주문 관련**   | DB 트리거 + API | ✅ 완비   |
| **심부름 관련** | DB 트리거 + API | ✅ 완비   |
| **분쟁 관련**   | DB 트리거       | ✅ 완비   |
| **정산/출금**   | DB 트리거       | ✅ 완비   |
| **헬퍼 검증**   | DB 트리거       | ✅ 완비   |
| **푸시 알림**   | Swing2App 연동  | ✅ 구현됨 |

---

## 1. 주문 관련 알림 (서비스 거래)

### 📋 구현된 알림 목록

| 이벤트          | 발신 → 수신         | 알림 타입                  | 트리거 방식                            |
| --------------- | ------------------- | -------------------------- | -------------------------------------- |
| 새 주문 생성    | 구매자 → **판매자** | `order_new`                | DB 트리거 `trigger_notify_new_order`   |
| 결제 완료       | 시스템 → **판매자** | `payment_received`         | API `notifyPaymentReceived()`          |
| 작업 시작       | 판매자 → **구매자** | `order_started`            | DB 트리거 `notify_order_status_change` |
| 작업 완료(납품) | 판매자 → **구매자** | `order_delivered`          | DB 트리거                              |
| 수정 요청       | 구매자 → **판매자** | `order_revision_requested` | DB 트리거                              |
| 수정 완료       | 판매자 → **구매자** | `order_revision_completed` | DB 트리거                              |
| 구매 확정       | 구매자 → **판매자** | `order_completed`          | DB 트리거                              |
| 주문 취소       | 취소자 → **상대방** | `order_cancelled`          | DB 트리거 + API                        |
| 리뷰 등록       | 구매자 → **판매자** | `new_review`               | API `notifyNewReview()`                |
| 새 메시지       | 발신자 → **수신자** | `new_message`              | API `notifyNewMessage()`               |

**상태**: ✅ **완전 구현됨**

---

## 2. 심부름(배달/구매대행) 관련 알림

### 📋 구현된 알림 목록

| 이벤트             | 발신 → 수신              | 알림 타입                     | 트리거 방식                                     |
| ------------------ | ------------------------ | ----------------------------- | ----------------------------------------------- |
| 새 심부름 등록     | 요청자 → **활성 헬퍼들** | `new_errand`                  | API `sendNewErrandNotifications()`              |
| 헬퍼 지원          | 헬퍼 → **요청자**        | `errand_application`          | DB 트리거 `on_errand_application_created`       |
| 지원 수락          | 요청자 → **헬퍼**        | `errand_application_accepted` | DB 트리거 `on_errand_application_status_change` |
| 지원 거절          | 요청자 → **헬퍼**        | `errand_application_rejected` | DB 트리거                                       |
| 라이더 배정 완료   | 시스템 → **요청자**      | `errand_matched`              | API `sendMatchedNotification()`                 |
| 심부름 시작        | 헬퍼 → **요청자**        | `errand_started`              | DB 트리거 `on_errand_status_change`             |
| 심부름 완료        | 헬퍼 → **요청자**        | `errand_completed`            | DB 트리거                                       |
| 심부름 취소        | 취소자 → **상대방**      | `errand_cancelled`            | DB 트리거                                       |
| 심부름 채팅 메시지 | 발신자 → **수신자**      | `errand_chat`                 | API (errands/[id]/chat)                         |

**상태**: ✅ **완전 구현됨**

---

## 3. 정산 및 출금 알림 (헬퍼용)

| 이벤트           | 발신 → 수신         | 알림 타입              | 트리거 방식                         |
| ---------------- | ------------------- | ---------------------- | ----------------------------------- |
| 정산금 출금 가능 | 시스템 → **헬퍼**   | `settlement_available` | DB 트리거 `on_settlement_available` |
| 출금 신청 접수   | 헬퍼 → **관리자들** | `withdrawal_requested` | DB 트리거 `on_withdrawal_requested` |
| 출금 완료        | 관리자 → **헬퍼**   | `withdrawal_completed` | DB 트리거 `on_withdrawal_result`    |
| 출금 거절        | 관리자 → **헬퍼**   | `withdrawal_rejected`  | DB 트리거                           |

**상태**: ✅ **완전 구현됨**

---

## 4. 분쟁 관련 알림

| 이벤트         | 발신 → 수신                | 알림 타입                | 트리거 방식                           |
| -------------- | -------------------------- | ------------------------ | ------------------------------------- |
| 분쟁 제기      | 원고 → **피고 + 관리자들** | `dispute_created`        | DB 트리거 `on_dispute_created`        |
| 답변 요청      | 시스템 → **피고**          | `dispute_status_changed` | DB 트리거 `on_dispute_status_changed` |
| AI 심사 시작   | 시스템 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |
| AI 판결 완료   | 시스템 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |
| 이의 신청 접수 | 신청자 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |
| 관리자 검토 중 | 시스템 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |
| 분쟁 해결      | 시스템 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |
| 양측 합의      | 시스템 → **원고, 피고**    | `dispute_status_changed` | DB 트리거                             |

**상태**: ✅ **완전 구현됨**

---

## 5. 헬퍼(라이더) 검증 알림

| 이벤트    | 발신 → 수신         | 알림 타입             | 트리거 방식                            |
| --------- | ------------------- | --------------------- | -------------------------------------- |
| 서류 제출 | 헬퍼 → **관리자들** | `helper_verification` | DB 트리거 `on_helper_documents_change` |
| 서류 승인 | 관리자 → **헬퍼**   | `helper_verification` | DB 트리거                              |
| 서류 반려 | 관리자 → **헬퍼**   | `helper_verification` | DB 트리거                              |

**상태**: ✅ **완전 구현됨**

---

## 6. 광고 관련 알림

| 이벤트             | 발신 → 수신         | 알림 타입         | 트리거 방식                 |
| ------------------ | ------------------- | ----------------- | --------------------------- |
| 결제 실패          | 시스템 → **판매자** | `payment_failed`  | API (`advertising-cron.ts`) |
| 크레딧 만료 예정   | 시스템 → **판매자** | `credit_expired`  | API (`advertising-cron.ts`) |
| 무료 프로모션 만료 | 시스템 → **판매자** | `payment_expired` | API (`advertising.ts`)      |

**상태**: ✅ **완전 구현됨**

---

## 7. 관리자 알림 수신 목록

관리자(`role = 'admin'`)는 다음 상황에서 알림을 수신합니다:

| 상황                | 알림 타입              |
| ------------------- | ---------------------- |
| 새 분쟁 접수        | `dispute`              |
| 헬퍼 서류 검토 요청 | `helper_verification`  |
| 출금 신청 접수      | `withdrawal_requested` |

**상태**: ✅ **구현됨**

---

## 8. 푸시 알림 시스템

### 구현 현황

1. **웹 푸시 (Service Worker)**: `/sw.js`, `/api/push/*`
2. **앱 푸시 (Swing2App)**: `/lib/swing2app/server.ts`
3. **푸시 대기열**: `push_notification_queue` 테이블
4. **Cron 처리**: `/api/cron/push-notifications`

### 푸시 알림 흐름

```
알림 생성 (notifications INSERT)
    ↓
trigger_push_notification (트리거)
    ↓
push_notification_queue 삽입
    ↓
Cron Job (/api/cron/push-notifications)
    ↓
Swing2App API 호출 → 앱 푸시 발송
```

**상태**: ✅ **완전 구현됨**

---

## 📌 누락된 알림 점검

### 점검 결과: ⚠️ 일부 개선 권장

| 시나리오                        | 현재 상태    | 권장 사항                                           |
| ------------------------------- | ------------ | --------------------------------------------------- |
| 구매자가 결제 완료 시 확인 알림 | ❌ 미구현    | 구매자에게도 "결제가 완료되었습니다" 알림 추가 권장 |
| 자동 구매확정 (3일 경과)        | ✅ 구현됨    | `notifyOrderConfirmed()` 함수 존재                  |
| 심부름 지원 마감 시 낙첨 알림   | ⚠️ 부분 구현 | 현재는 수락/거절만 알림, 마감 시 일괄 알림 없음     |
| 문의 답변 알림                  | ✅ 구현됨    | `notify_inquiry_answered` 트리거 존재               |

---

## 9. 권장 개선 사항

### 9.1 즉시 적용 권장 (Minor)

1. **구매자 결제 완료 알림 추가**
   - 현재 판매자에게만 알림이 감
   - 구매자에게도 "결제가 정상 처리되었습니다" 확인 알림 권장

2. **심부름 마감 시 낙첨 알림**
   - 심부름이 MATCHED 상태로 변경될 때
   - 대기 중이던 다른 지원자들에게 "다른 헬퍼가 선정되었습니다" 알림

### 9.2 선택적 개선 (Optional)

1. **알림 그룹핑**
   - 동일 타입 알림이 많을 경우 묶어서 "외 N건" 형태로 표시

2. **알림 우선순위**
   - 결제/정산 관련 알림은 높은 우선순위로 표시

---

## 10. 결론

| 항목           | 상태                    |
| -------------- | ----------------------- |
| 주문 알림      | ✅ 완비 (10개 시나리오) |
| 심부름 알림    | ✅ 완비 (9개 시나리오)  |
| 분쟁 알림      | ✅ 완비 (8개 상태 변화) |
| 정산/출금 알림 | ✅ 완비 (4개 시나리오)  |
| 헬퍼 검증 알림 | ✅ 완비 (3개 시나리오)  |
| 관리자 알림    | ✅ 완비 (3개 타입)      |
| 푸시 알림      | ✅ 완비 (웹/앱 모두)    |

## 🏆 최종 평가: **A** (알림 시스템 정상 동작)

플랫폼의 모든 주요 상호작용에 대해 알림이 **양방향으로 정상 구현**되어 있습니다.

**일부 개선 권장 사항**:

- 구매자 결제 완료 확인 알림 추가
- 심부름 낙첨 알림 추가

---

_이 보고서는 데이터베이스 트리거 및 API 코드 분석을 기반으로 작성되었습니다._
